<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[安卓微信朋友圈分享功能]]></title>
      <url>https://bingofan.github.io/2016/08/12/wiki-android-weixinshare/</url>
      <content type="html"><![CDATA[<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>阅读<a href="https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&amp;t=resource/res_list&amp;verify=1&amp;id=1417751808&amp;token=&amp;lang=zh_CN" target="_blank" rel="external">微信的官方文档</a> 在官方文档的内容里罗列了微信WPI开发的基本步骤.<br>1.申请你的AppID<br>2.下载微信终端开发工具包<br><a href="https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&amp;t=resource/res_list&amp;verify=1&amp;id=open1419319167&amp;lang=zh_CN" target="_blank" rel="external">SDK的下载</a><br>3.搭建开发环境<br>4.在代码中使用开发工具包<br>这里有一个Demo程序蛮重要的,很简练.<br><a id="more"></a></p>
<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>点击右上角分享按钮,弹出下拉框,选择相应”微信”或者”朋友圈”<br>调出微信APP进行相关内容的分享.<br><img src="\images\wiki\wiki-android-weixinshare\1.png" alt="微信分享上拉选项"></p>
<h3 id="导入SDK包"><a href="#导入SDK包" class="headerlink" title="导入SDK包"></a>导入SDK包</h3><p>1.将开发工具包中libs目录下的libammsdk.jar复制到项目的lib目录中<br><img src="\images\wiki\wiki-android-weixinshare\3.png" alt="工程导入包"><br>2.在你需要使用微信终端API的文件中导入相应的类。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.tencent.mm.sdk.openapi.WXTextObject;</div></pre></td></tr></table></figure></p>
<p>3.AndroidManifest.xml 设置<br>添加必要的权限支持:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.INTERNET"</span>/&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span>/&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_WIFI_STATE"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.READ_PHONE_STATE"</span>/&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="上拉菜单"><a href="#上拉菜单" class="headerlink" title="上拉菜单"></a>上拉菜单</h3><p><code>PopupWindow</code>的实现.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SNSSharePopupWindows</span> <span class="keyword">extends</span> <span class="title">PopupWindow</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> ImageButton mWeiXinBtn, mWeiBoBtn, mPengYouquanBtn, mQQBtn;</div><div class="line">    <span class="keyword">private</span> WechatShareManager mWechatShareManager;</div><div class="line">    <span class="keyword">private</span> WechatShareManager.ShareContentWebpage mShareContentWebpage;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Toast mToast;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@param</span> mContext</div><div class="line">     * <span class="doctag">@param</span> parent</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SNSSharePopupWindows</span><span class="params">(<span class="keyword">final</span> Activity mContext, View parent)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(mContext);</div><div class="line"></div><div class="line">        mWechatShareManager = WechatShareManager.getInstance(mContext);</div><div class="line">        mToast = Toast.makeText(mContext, <span class="string">""</span>, Toast.LENGTH_SHORT);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> View view = View.inflate(mContext,</div><div class="line">                R.layout.item_popupsharewindows, <span class="keyword">null</span>);</div><div class="line">        view.startAnimation(AnimationUtils.loadAnimation(mContext,</div><div class="line">                R.anim.fade_ins));</div><div class="line">        <span class="keyword">final</span> LinearLayout linearLayout = (LinearLayout) view</div><div class="line">                .findViewById(R.id.share_ll_popup);</div><div class="line">        linearLayout.startAnimation(AnimationUtils.loadAnimation(mContext,</div><div class="line">                R.anim.push_bottom_in));</div><div class="line"></div><div class="line">        setWidth(ViewGroup.LayoutParams.MATCH_PARENT);</div><div class="line">        setHeight(ViewGroup.LayoutParams.MATCH_PARENT);</div><div class="line">        setBackgroundDrawable(<span class="keyword">new</span> BitmapDrawable());</div><div class="line">        setFocusable(<span class="keyword">true</span>);</div><div class="line">        setOutsideTouchable(<span class="keyword">true</span>);</div><div class="line">        setContentView(view);</div><div class="line">        showAtLocation(parent, Gravity.BOTTOM, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">        update();</div><div class="line"></div><div class="line">        <span class="comment">//触摸分享框外面的部分,分享弹出框消失.</span></div><div class="line">        view.setOnTouchListener(<span class="keyword">new</span> View.OnTouchListener() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouch</span><span class="params">(View v, MotionEvent event)</span> </span>&#123;</div><div class="line">                <span class="keyword">int</span> height = view.findViewById(R.id.share_ll_popup).getTop();</div><div class="line">                <span class="keyword">int</span> y = (<span class="keyword">int</span>) event.getY();</div><div class="line">                <span class="keyword">if</span> (event.getAction() == MotionEvent.ACTION_UP) &#123;</div><div class="line">                    <span class="keyword">if</span> (y &lt; height) &#123;</div><div class="line">                        dismiss();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="comment">//四个分享按钮</span></div><div class="line">        mWeiXinBtn = (ImageButton) view</div><div class="line">                .findViewById(R.id.item_sharepopupwindows_weixin);</div><div class="line">        mPengYouquanBtn = (ImageButton) view</div><div class="line">                .findViewById(R.id.item_sharepopupwindows_pengyouquan);</div><div class="line">        mWeiBoBtn = (ImageButton) view</div><div class="line">                .findViewById(R.id.item_sharepopupwindows_weibo);</div><div class="line">        mQQBtn = (ImageButton) view</div><div class="line">                .findViewById(R.id.item_sharepopupwindows_qq);</div><div class="line"></div><div class="line">        mWeiXinBtn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                <span class="comment">//检测是否安装微信</span></div><div class="line">                <span class="keyword">if</span> (!checkSNSAvaliable(mWeiXinBtn))</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != mShareContentWebpage) &#123;</div><div class="line">                    mWechatShareManager.shareByWebchat(mShareContentWebpage,</div><div class="line">                            WechatShareManager.WECHAT_SHARE_TYPE_SESSION);</div><div class="line">                    <span class="comment">//分享成功与否,都设为分享结束,对话框消失.</span></div><div class="line">                    dismiss();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        mPengYouquanBtn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (!checkSNSAvaliable(mPengYouquanBtn))</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != mShareContentWebpage) &#123;</div><div class="line">                    mWechatShareManager.shareByWebchat(mShareContentWebpage,</div><div class="line">                            WechatShareManager.WECHAT_SHARE_TYPE_TIMELINE);</div><div class="line">                    <span class="comment">//分享成功与否,都设为分享结束,对话框消失.</span></div><div class="line">                    dismiss();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><code>WechatShareManager</code>是一个单例模式的类,负责管理所有的微信相关的内容的分享.<br>检测微信安装<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 检测手机上是否安装了微信</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isWebchatAvaliable</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        mContext.getPackageManager().getPackageInfo(WECHAT_PACKAGE_NAME, PackageManager.GET_ACTIVITIES);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>布局文件 <code>item_popupsharewindows.xml</code><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:background</span>=<span class="string">"@android:drawable/screen_background_dark_transparent"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/share_ll_popup"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_alignParentBottom</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"@color/white"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span> &gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"1dp"</span></div><div class="line">            <span class="attr">android:background</span>=<span class="string">"@drawable/list_line"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"55dp"</span></div><div class="line">            <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span></div><div class="line">            <span class="attr">android:gravity</span>=<span class="string">"center"</span>&gt;</div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">                <span class="attr">android:id</span>=<span class="string">"@+id/share_title"</span></div><div class="line">                <span class="attr">android:background</span>=<span class="string">"@drawable/bg_center_selector"</span></div><div class="line">                <span class="attr">android:textColor</span>=<span class="string">"@color/gray"</span></div><div class="line">                <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">                <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">                <span class="attr">android:gravity</span>=<span class="string">"center"</span></div><div class="line">                <span class="attr">android:layout_centerVertical</span>=<span class="string">"true"</span></div><div class="line">                <span class="attr">android:layout_gravity</span>=<span class="string">"center"</span></div><div class="line">                <span class="attr">android:textSize</span>=<span class="string">"22sp"</span></div><div class="line">                <span class="attr">android:text</span>=<span class="string">"分享"</span>/&gt;</div><div class="line">        <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"0.5dp"</span></div><div class="line">            <span class="attr">android:background</span>=<span class="string">"@drawable/list_line"</span> /&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"120dp"</span></div><div class="line">            <span class="attr">android:padding</span>=<span class="string">"@dimen/dimen_10dp"</span></div><div class="line">            <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span> &gt;</div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">ImageButton</span></span></div><div class="line">                <span class="attr">android:id</span>=<span class="string">"@+id/item_sharepopupwindows_weixin"</span></div><div class="line">                <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">                <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></div><div class="line">                <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></div><div class="line">                <span class="attr">android:background</span>=<span class="string">"@drawable/bg_center_selector"</span></div><div class="line">                <span class="attr">android:src</span>=<span class="string">"@drawable/share_weixin_btn"</span></div><div class="line">                <span class="attr">android:scaleType</span>=<span class="string">"center"</span></div><div class="line">             /&gt;</div><div class="line">            <span class="tag">&lt;<span class="name">ImageButton</span></span></div><div class="line">                <span class="attr">android:id</span>=<span class="string">"@+id/item_sharepopupwindows_pengyouquan"</span></div><div class="line">                <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">                <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></div><div class="line">                <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></div><div class="line">                <span class="attr">android:background</span>=<span class="string">"@drawable/bg_center_selector"</span></div><div class="line">                <span class="attr">android:src</span>=<span class="string">"@drawable/share_pengyouquan_btn"</span></div><div class="line">                <span class="attr">android:scaleType</span>=<span class="string">"center"</span></div><div class="line">                /&gt;</div><div class="line">            <span class="tag">&lt;<span class="name">ImageButton</span></span></div><div class="line">                <span class="attr">android:id</span>=<span class="string">"@+id/item_sharepopupwindows_qq"</span></div><div class="line">                <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">                <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></div><div class="line">                <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></div><div class="line">                <span class="attr">android:background</span>=<span class="string">"@drawable/bg_center_selector"</span></div><div class="line">                <span class="attr">android:src</span>=<span class="string">"@drawable/share_qq_btn"</span></div><div class="line">                <span class="attr">android:scaleType</span>=<span class="string">"center"</span></div><div class="line">                /&gt;</div><div class="line">            <span class="tag">&lt;<span class="name">ImageButton</span></span></div><div class="line">                <span class="attr">android:id</span>=<span class="string">"@+id/item_sharepopupwindows_weibo"</span></div><div class="line">                <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">                <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></div><div class="line">                <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></div><div class="line">                <span class="attr">android:background</span>=<span class="string">"@drawable/bg_center_selector"</span></div><div class="line">                <span class="attr">android:src</span>=<span class="string">"@drawable/share_weibo_btn"</span></div><div class="line">                <span class="attr">android:scaleType</span>=<span class="string">"center"</span></div><div class="line">                /&gt;</div><div class="line">        <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="分享流程"><a href="#分享流程" class="headerlink" title="分享流程"></a>分享流程</h3><p>分享过程主要是在<code>WeixinShareManager</code>里面完成的.下面来看看<code>WeixinShareManager</code> 做什么的.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">... ...</div><div class="line"><span class="comment">//单例模式初始化</span></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="title">WechatShareManager</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>.mContext = context;</div><div class="line">       initWechatShare(context);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line"><span class="comment">//api注册</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initWechatShare</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (mWXApi == <span class="keyword">null</span>) &#123;</div><div class="line">           mWXApi = WXAPIFactory.createWXAPI(context, WECHAT_APP_ID, <span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">       mWXApi.registerApp(WECHAT_APP_ID);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">... ...</div><div class="line"></div><div class="line">   <span class="comment">/*</span></div><div class="line">    * 分享链接</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">shareWebPage</span><span class="params">(ShareContent shareContent, <span class="keyword">int</span> shareType)</span> </span>&#123;</div><div class="line">	<span class="comment">// 初始化一个WXTextObject对象</span></div><div class="line">       WXWebpageObject webpage = <span class="keyword">new</span> WXWebpageObject();</div><div class="line">       webpage.webpageUrl = shareContent.getURL();</div><div class="line">       <span class="comment">// 用WXTextObject对象初始化一个WXMediaMessage对象</span></div><div class="line">       WXMediaMessage msg = <span class="keyword">new</span> WXMediaMessage(webpage);</div><div class="line"></div><div class="line">	<span class="comment">// 发送文本类型的消息时，title字段不起作用</span></div><div class="line">       msg.title = shareContent.getTitle();</div><div class="line">       <span class="comment">//截取最大长度的标题</span></div><div class="line">       <span class="keyword">if</span> (msg.title.length() &gt;= TITILE_SIZE)</div><div class="line">           msg.title = msg.title.substring(<span class="number">0</span>, TITILE_SIZE - <span class="number">1</span>);</div><div class="line"></div><div class="line">       msg.description = shareContent.getContent();</div><div class="line">       <span class="comment">//截取最大长度的描述</span></div><div class="line">       <span class="keyword">if</span> (msg.description.length() &gt;= CONTENT_SIZE)</div><div class="line">           msg.description = msg.description.substring(<span class="number">0</span>, CONTENT_SIZE - <span class="number">1</span>);</div><div class="line"></div><div class="line">       Logger.Log(WechatShareUtil.TAG, <span class="string">"getImageURL "</span> + shareContent.getImageURL() +</div><div class="line">               <span class="string">"\n getPictureResource "</span> + shareContent.getPictureResource() +</div><div class="line">               <span class="string">"\n getTitle"</span> + shareContent.getTitle() +</div><div class="line">               <span class="string">"\n getContent"</span>  + shareContent.getContent() +</div><div class="line">               <span class="string">"\n getURL"</span> + shareContent.getURL());</div><div class="line"></div><div class="line">       <span class="keyword">boolean</span> useDefaultImage = StringUtils.StrIsNull(shareContent.getImageURL())? <span class="keyword">true</span>:<span class="keyword">false</span>;</div><div class="line">       Bitmap thumb = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">if</span> (!useDefaultImage) &#123;</div><div class="line">           thumb = QDApplicationContext.imageLoader.loadImageSync(shareContent.getImageURL(), <span class="keyword">new</span> ImageSize(THUMB_SIZE,THUMB_SIZE));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           thumb = BitmapFactory.decodeResource(mContext.getResources(), shareContent.getPictureResource());</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (thumb == <span class="keyword">null</span>) &#123;</div><div class="line">           thumb = BitmapFactory.decodeResource(mContext.getResources(), R.drawable.hos_default_logo);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           msg.thumbData = WechatShareUtil.bmpToByteArray(thumb, <span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">	<span class="comment">// 构造一个Req</span></div><div class="line">       SendMessageToWX.Req req = <span class="keyword">new</span> SendMessageToWX.Req();</div><div class="line">	<span class="comment">// transaction字段用于唯一标识一个请求 img,video,text等</span></div><div class="line">       req.transaction = buildTransaction(<span class="string">"webpage"</span>);</div><div class="line">       req.message = msg;</div><div class="line">       req.scene = shareType;</div><div class="line">       <span class="comment">// 调用api接口发送数据到微信</span></div><div class="line">       mWXApi.sendReq(req);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>从上面核心代码看,<code>WeixinShareManager</code>做了这样几件事情:<br>1.注册微信API<br>2.构造WXMediaMessage<br>3.初始化SendMessageToWX.Req,并指定分享类型(网页,图片,文本等等)<br>4.发送分享请求.</p>
<p>这样就完成了整个的分享过程.<br>图片,文本什么的类似.<br><span class="label label-warning">关于缩略图</span><br><div class="alert alert-warning"><i class="fa fa-bell"></i>  微信关于缩略图的大小有严格的限制的,如果超出限制会分享不成功.(`没有警告,就是分享不成功`)
我这里采用了100x100的大小做了压缩,我试过120x120不能成功.</div><br></p><p class="text-info">腾讯官方给的Demo里面给出的图片分享的缩略图限制是150x150的.API文档里说明是不超过10M.缩略图大小不超过32KB
但是没有给出网页分享的缩略图大小.</p><br><img src="\images\wiki\wiki-android-weixinshare\2.png" alt="微信SDK截图"><br>具体的bitmap占内存大小问题,这篇文章可以收藏 <a href="http://bugly.qq.com/bbs/forum.php?mod=viewthread&amp;tid=498" target="_blank" rel="external">Android 开发绕不过的坑：你的 Bitmap 究竟占多大内存？</a><p></p>
<h3 id="分享之后"><a href="#分享之后" class="headerlink" title="分享之后"></a>分享之后</h3><p>那么如何收到分享成功或者失败的通知呢.<br>微信接受的入口类在<code>packagename.wxapi</code>包下，它的分享结果回调也在这个类<br>微信会在<code>packagename.wxapi</code>找这个回调接口的类，这个类必须是集成了<code>Activity</code>的类，并且实现<code>IWXAPIEventHandler</code>接口<br></p><p class="text-info">这个类的名字一定要是`WXEntryActivity.java`；</p><br>这样，你就可以接受到微信回调结果了：<br>1.现在你的当前工程目录下新建wxapi文件夹并添加类<code>WXEntryActivity.java</code><br><img src="\images\wiki\wiki-android-weixinshare\4.png" alt="微信分享上拉选项"><br>2.这个类<code>WXEntryActivity.java</code>在<code>onCreate</code>中注册API.<br>3.重写<code>onReq</code>回调函数,提示成功或者失败.<p></p>
<p><code>WXEntryActivity</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WXEntryActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">IWXAPIEventHandler</span></span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIMELINE_SUPPORTED_VERSION = <span class="number">0x21020001</span>;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> Button gotoBtn, regBtn, launchBtn, checkBtn;</div><div class="line">	</div><div class="line">	<span class="comment">// IWXAPI 是第三方app和微信通信的openapi接口</span></div><div class="line">    <span class="keyword">private</span> IWXAPI api;</div><div class="line">	</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.entry);</div><div class="line">        </div><div class="line">        <span class="comment">// 通过WXAPIFactory工厂，获取IWXAPI的实例</span></div><div class="line">    	api = WXAPIFactory.createWXAPI(<span class="keyword">this</span>, Constants.APP_ID, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">    	regBtn = (Button) findViewById(R.id.reg_btn);</div><div class="line">    	regBtn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">			</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">				<span class="comment">// 将该app注册到微信</span></div><div class="line">			    api.registerApp(Constants.APP_ID);    	</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">    	</div><div class="line">        gotoBtn = (Button) findViewById(R.id.goto_send_btn);</div><div class="line">        gotoBtn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">			</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">		        startActivity(<span class="keyword">new</span> Intent(WXEntryActivity.<span class="keyword">this</span>, SendToWXActivity.class));</div><div class="line">		        finish();</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">        </div><div class="line">        launchBtn = (Button) findViewById(R.id.launch_wx_btn);</div><div class="line">        launchBtn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">			</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">				Toast.makeText(WXEntryActivity.<span class="keyword">this</span>, <span class="string">"launch result = "</span> + api.openWXApp(), Toast.LENGTH_LONG).show();</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">        </div><div class="line">        checkBtn = (Button) findViewById(R.id.check_timeline_supported_btn);</div><div class="line">        checkBtn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">			</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">				<span class="keyword">int</span> wxSdkVersion = api.getWXAppSupportAPI();</div><div class="line">				<span class="keyword">if</span> (wxSdkVersion &gt;= TIMELINE_SUPPORTED_VERSION) &#123;</div><div class="line">					Toast.makeText(WXEntryActivity.<span class="keyword">this</span>, <span class="string">"wxSdkVersion = "</span> + Integer.toHexString(wxSdkVersion) + <span class="string">"\ntimeline supported"</span>, Toast.LENGTH_LONG).show();</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					Toast.makeText(WXEntryActivity.<span class="keyword">this</span>, <span class="string">"wxSdkVersion = "</span> + Integer.toHexString(wxSdkVersion) + <span class="string">"\ntimeline not supported"</span>, Toast.LENGTH_LONG).show();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">        </div><div class="line">        api.handleIntent(getIntent(), <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onNewIntent</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>.onNewIntent(intent);</div><div class="line">		</div><div class="line">		setIntent(intent);</div><div class="line">        api.handleIntent(intent, <span class="keyword">this</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 微信发送请求到第三方应用时，会回调到该方法</span></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReq</span><span class="params">(BaseReq req)</span> </span>&#123;</div><div class="line">		<span class="keyword">switch</span> (req.getType()) &#123;</div><div class="line">		<span class="keyword">case</span> ConstantsAPI.COMMAND_GETMESSAGE_FROM_WX:</div><div class="line">			goToGetMsg();		</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> ConstantsAPI.COMMAND_SHOWMESSAGE_FROM_WX:</div><div class="line">			goToShowMsg((ShowMessageFromWX.Req) req);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 第三方应用发送到微信的请求处理后的响应结果，会回调到该方法</span></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResp</span><span class="params">(BaseResp resp)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line">		</div><div class="line">		<span class="keyword">switch</span> (resp.errCode) &#123;</div><div class="line">		<span class="keyword">case</span> BaseResp.ErrCode.ERR_OK:</div><div class="line">			result = R.string.errcode_success;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> BaseResp.ErrCode.ERR_USER_CANCEL:</div><div class="line">			result = R.string.errcode_cancel;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> BaseResp.ErrCode.ERR_AUTH_DENIED:</div><div class="line">			result = R.string.errcode_deny;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			result = R.string.errcode_unknown;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		Toast.makeText(<span class="keyword">this</span>, result, Toast.LENGTH_LONG).show();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">goToGetMsg</span><span class="params">()</span> </span>&#123;</div><div class="line">		Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, GetFromWXActivity.class);</div><div class="line">		intent.putExtras(getIntent());</div><div class="line">		startActivity(intent);</div><div class="line">		finish();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">goToShowMsg</span><span class="params">(ShowMessageFromWX.Req showReq)</span> </span>&#123;</div><div class="line">		WXMediaMessage wxMsg = showReq.message;		</div><div class="line">		WXAppExtendObject obj = (WXAppExtendObject) wxMsg.mediaObject;</div><div class="line">		</div><div class="line">		StringBuffer msg = <span class="keyword">new</span> StringBuffer(); <span class="comment">// 组织一个待显示的消息内容</span></div><div class="line">		msg.append(<span class="string">"description: "</span>);</div><div class="line">		msg.append(wxMsg.description);</div><div class="line">		msg.append(<span class="string">"\n"</span>);</div><div class="line">		msg.append(<span class="string">"extInfo: "</span>);</div><div class="line">		msg.append(obj.extInfo);</div><div class="line">		msg.append(<span class="string">"\n"</span>);</div><div class="line">		msg.append(<span class="string">"filePath: "</span>);</div><div class="line">		msg.append(obj.filePath);</div><div class="line">		</div><div class="line">		Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, ShowFromWXActivity.class);</div><div class="line">		intent.putExtra(Constants.ShowMsgActivity.STitle, wxMsg.title);</div><div class="line">		intent.putExtra(Constants.ShowMsgActivity.SMessage, msg.toString());</div><div class="line">		intent.putExtra(Constants.ShowMsgActivity.BAThumbData, wxMsg.thumbData);</div><div class="line">		startActivity(intent);</div><div class="line">		finish();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h2><p>整个过程差不多就是这样.<br>后续再慢慢做补充.<br>关于完成这个功能的时候,我遇到的坑就是缩略图大小问题,后来解决掉了.<br>这一块儿有时间还得研究研究~.</p>
]]></content>
    </entry>
    
  
  
</search>
